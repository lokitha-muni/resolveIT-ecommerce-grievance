<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage All Complaints ‚Äì ResolveIT Admin</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    <script>
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
    <!-- Background -->
    <div class="split-background">
        <div class="bg-left"></div>
        <div class="bg-right"></div>
    </div>

    <!-- Main Container -->
    <div class="dashboard-main">
        <!-- Top Navigation -->
        <nav class="dashboard-nav">
            <div class="nav-left">
                <div class="profile-photo">AD</div>
                <span>Admin - All Complaints</span>
            </div>
            <div class="nav-right">
                <button onclick="refreshData()" class="nav-btn" style="background: #f8f9fa; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; margin-right: 1rem;">üîÑ Refresh</button>
                <a href="admin-dashboard.html" class="nav-btn">‚Üê Back to Dashboard</a>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </nav>

        <!-- Admin Stats -->
        <section class="stats-section">
            <div class="stat-card">
                <div class="stat-label">Total Complaints</div>
                <div class="stat-number" id="totalComplaints">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unassigned</div>
                <div class="stat-number" id="unassignedComplaints">0</div>
            </div>
            <div class="stat-card progress-card">
                <div class="stat-label">Active Agents</div>
                <div class="stat-number" id="activeAgents">0</div>
            </div>
            <div class="stat-card resolved-card">
                <div class="stat-label">Avg Resolution</div>
                <div class="stat-number" id="avgResolution">0h</div>
            </div>
        </section>

        <!-- Admin Controls -->
        <div class="admin-controls">
            <div class="control-group">
                <select class="admin-select" id="statusFilter">
                    <option value="all">All Status</option>
                    <option value="PENDING">Pending</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="RESOLVED">Resolved</option>
                    <option value="FORCE_CLOSED">Force Closed</option>
                </select>
                <select class="admin-select" id="priorityFilter">
                    <option value="all">All Priority</option>
                    <option value="High">High Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="Low">Low Priority</option>
                </select>
                <select class="admin-select" id="agentFilter">
                    <option value="all">All Agents</option>
                    <option value="unassigned">Unassigned</option>
                </select>
                <button class="admin-filter-btn" onclick="applyFilters()">Apply Filters</button>
            </div>
            <div class="bulk-admin-actions">
                <button class="admin-bulk-btn" onclick="bulkAssign()">Bulk Assign</button>
                <button class="admin-bulk-btn" onclick="bulkExport()">Export All</button>
                <button class="admin-bulk-btn" onclick="generateReport()">Generate Report</button>
            </div>
        </div>

        <!-- All Complaints Table -->
        <section class="complaints-section">
            <div class="complaints-card">
                <div class="admin-table-header">
                    <h2>All System Complaints</h2>
                    <div class="table-actions">
                        <button class="table-action-btn" onclick="refreshData()">Refresh</button>
                        <button class="table-action-btn" onclick="addComplaint()">Add Complaint</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="complaints-table admin-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllAdmin" onchange="toggleSelectAllAdmin()"></th>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Order ID</th>
                                <th>Issue Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Assigned Agent</th>
                                <th>Created</th>
                                <th>SLA Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complaintsTableBody">
                            <!-- Complaints will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Admin Analytics -->
        <section class="admin-analytics">
            <div class="dashboard-container">
                <h2>System Analytics</h2>
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>Resolution Rate</h3>
                        <div class="metric-value" id="resolutionRate">0%</div>
                        <div class="metric-trend">+5% this week</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Avg Response Time</h3>
                        <div class="metric-value" id="responseTime">0h</div>
                        <div class="metric-trend">-15min improved</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Customer Satisfaction</h3>
                        <div class="metric-value">4.6/5</div>
                        <div class="metric-trend">+0.2 this month</div>
                    </div>
                    <div class="analytics-card">
                        <h3>Agent Workload</h3>
                        <div class="metric-value" id="agentWorkload">0</div>
                        <div class="metric-trend">Balanced</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let allComplaints = [];
        let allStaff = [];
        let filteredComplaints = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();
        });
        
        async function loadAdminData() {
            try {
                // Load complaints and stats
                const [complaintsResponse, statsResponse, staffResponse] = await Promise.all([
                    fetch('http://localhost:9090/api/admin/complaints'),
                    fetch('http://localhost:9090/api/admin/stats'),
                    fetch('http://localhost:9090/api/admin/staff')
                ]);
                
                if (complaintsResponse.ok) {
                    allComplaints = await complaintsResponse.json();
                    filteredComplaints = [...allComplaints];
                    renderComplaints();
                }
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateStats(stats);
                }
                
                if (staffResponse.ok) {
                    allStaff = await staffResponse.json();
                    populateAgentFilter();
                }
                
                calculateAnalytics();
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function updateStats(stats) {
            document.getElementById('totalComplaints').textContent = stats.totalComplaints || 0;
            document.getElementById('unassignedComplaints').textContent = stats.unassigned || 0;
            document.getElementById('activeAgents').textContent = stats.activeAgents || 0;
            document.getElementById('avgResolution').textContent = stats.avgResolution || '0h';
        }
        
        function populateAgentFilter() {
            const agentFilter = document.getElementById('agentFilter');
            // Clear existing options except first two
            while (agentFilter.children.length > 2) {
                agentFilter.removeChild(agentFilter.lastChild);
            }
            
            allStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                agentFilter.appendChild(option);
            });
        }
        
        function renderComplaints() {
            const tbody = document.getElementById('complaintsTableBody');
            tbody.innerHTML = '';
            
            filteredComplaints.forEach(complaint => {
                const row = createComplaintRow(complaint);
                tbody.appendChild(row);
            });
            
            // Re-attach event listeners
            document.querySelectorAll('.admin-row-select').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
        }
        
        function createComplaintRow(complaint) {
            const row = document.createElement('tr');
            row.setAttribute('data-id', complaint.complaintId);
            
            // Add special classes based on status/priority
            if (complaint.priority === 'High' && complaint.status === 'PENDING') {
                row.classList.add('urgent-row');
            }
            if (!complaint.assignedAgent) {
                row.classList.add('unassigned-row');
            }
            
            const customerName = extractCustomerName(complaint.userEmail);
            const timeAgo = getTimeAgo(complaint.createdAt);
            const slaStatus = getSLAStatus(complaint);
            
            row.innerHTML = `
                <td><input type="checkbox" class="admin-row-select"></td>
                <td><strong>${complaint.complaintId}</strong></td>
                <td>${customerName}</td>
                <td>${complaint.orderId}</td>
                <td><span class="tag ${getIssueTypeClass(complaint.issueType)}">${complaint.issueType}</span></td>
                <td><span class="priority ${complaint.priority.toLowerCase()}">${complaint.priority}</span></td>
                <td><span class="status-badge ${getStatusClass(complaint.status)}">${formatStatus(complaint.status)}</span></td>
                <td>${complaint.assignedAgent || '<em>Not Assigned</em>'}</td>
                <td>${timeAgo}</td>
                <td><span class="${slaStatus.class}">${slaStatus.text}</span></td>
                <td><a href="admin-complaint-details.html?id=${complaint.complaintId}" class="view-link">View Details</a></td>
            `;
            
            return row;
        }
        
        function extractCustomerName(email) {
            if (email === 'test@gmail.com') return 'Test User';
            const name = email.split('@')[0].replace(/\./g, ' ');
            return name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        
        function getTimeAgo(createdAt) {
            if (!createdAt) return 'Recently';
            const now = new Date();
            const created = new Date(createdAt);
            const diffMs = now - created;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Recently';
        }
        
        function getSLAStatus(complaint) {
            if (complaint.status === 'RESOLVED' || complaint.status === 'FORCE_CLOSED') {
                return { class: 'sla-ok', text: 'Completed' };
            }
            if (!complaint.assignedAgent) {
                return { class: 'sla-warning', text: 'Needs Assignment' };
            }
            if (complaint.priority === 'High') {
                return { class: 'sla-critical', text: 'Critical' };
            }
            return { class: 'sla-ok', text: 'On Track' };
        }
        
        function getIssueTypeClass(issueType) {
            const typeMap = {
                'Wrong Product': 'orange',
                'Late Delivery': 'blue',
                'Damaged Product': 'orange',
                'Missing Item': 'yellow',
                'Quality Issue': 'red',
                'Billing Issue': 'purple'
            };
            return typeMap[issueType] || 'gray';
        }
        
        function getStatusClass(status) {
            const statusMap = {
                'PENDING': 'pending',
                'IN_PROGRESS': 'progress',
                'RESOLVED': 'resolved',
                'FORCE_CLOSED': 'closed'
            };
            return statusMap[status] || 'pending';
        }
        
        function formatStatus(status) {
            const statusMap = {
                'PENDING': 'Pending',
                'IN_PROGRESS': 'In Progress',
                'RESOLVED': 'Resolved',
                'FORCE_CLOSED': 'Force Closed'
            };
            return statusMap[status] || status;
        }
        
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const agentFilter = document.getElementById('agentFilter').value;
            
            filteredComplaints = allComplaints.filter(complaint => {
                const statusMatch = statusFilter === 'all' || complaint.status === statusFilter;
                const priorityMatch = priorityFilter === 'all' || complaint.priority === priorityFilter;
                const agentMatch = agentFilter === 'all' || 
                    (agentFilter === 'unassigned' && !complaint.assignedAgent) ||
                    complaint.assignedAgent === agentFilter;
                
                return statusMatch && priorityMatch && agentMatch;
            });
            
            renderComplaints();
        }
        
        function calculateAnalytics() {
            if (allComplaints.length === 0) return;
            
            const resolved = allComplaints.filter(c => c.status === 'RESOLVED').length;
            const resolutionRate = Math.round((resolved / allComplaints.length) * 100);
            
            const avgWorkload = allStaff.length > 0 ? 
                (allStaff.reduce((sum, staff) => sum + (staff.workload || 0), 0) / allStaff.length).toFixed(1) : 0;
            
            document.getElementById('resolutionRate').textContent = resolutionRate + '%';
            document.getElementById('responseTime').textContent = '1.2h';
            document.getElementById('agentWorkload').textContent = avgWorkload;
        }
        
        function toggleSelectAllAdmin() {
            const selectAll = document.getElementById('selectAllAdmin');
            const checkboxes = document.querySelectorAll('.admin-row-select');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.admin-row-select:checked').length;
            console.log(`${selected} complaints selected`);
        }

        function bulkAssign() {
            const selected = document.querySelectorAll('.admin-row-select:checked');
            if (selected.length === 0) {
                alert('Please select complaints to assign first');
                return;
            }
            
            const agent = prompt('Enter agent name to assign selected complaints:');
            if (agent && confirm(`Assign ${selected.length} complaints to ${agent}?`)) {
                console.log(`Assigning ${selected.length} complaints to ${agent}`);
                loadAdminData();
            }
        }

        function bulkExport() {
            if (confirm('Export all complaints data as CSV?')) {
                try {
                    const csvData = generateCSV(allComplaints);
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'admin_complaints_export.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Export error:', error);
                    alert('Export failed. Please try again.');
                }
            }
        }
        
        function generateCSV(complaints) {
            let csv = 'Complaint ID,Customer,Order ID,Issue Type,Priority,Status,Assigned Agent,Created\n';
            complaints.forEach(complaint => {
                csv += `"${complaint.complaintId}","${extractCustomerName(complaint.userEmail)}","${complaint.orderId}","${complaint.issueType}","${complaint.priority}","${complaint.status}","${complaint.assignedAgent || 'Unassigned'}","${getTimeAgo(complaint.createdAt)}"\n`;
            });
            return csv;
        }

        function generateReport() {
            if (confirm('Generate comprehensive system report?')) {
                const reportData = {
                    totalComplaints: allComplaints.length,
                    pendingComplaints: allComplaints.filter(c => c.status === 'PENDING').length,
                    inProgressComplaints: allComplaints.filter(c => c.status === 'IN_PROGRESS').length,
                    resolvedComplaints: allComplaints.filter(c => c.status === 'RESOLVED').length,
                    unassignedComplaints: allComplaints.filter(c => !c.assignedAgent).length,
                    highPriorityComplaints: allComplaints.filter(c => c.priority === 'High').length,
                    activeAgents: allStaff.length,
                    generatedAt: new Date().toISOString()
                };
                
                const reportText = `RESOLVEIT SYSTEM REPORT\n\nGenerated: ${new Date().toLocaleString()}\n\nSUMMARY:\nTotal Complaints: ${reportData.totalComplaints}\nPending: ${reportData.pendingComplaints}\nIn Progress: ${reportData.inProgressComplaints}\nResolved: ${reportData.resolvedComplaints}\nUnassigned: ${reportData.unassignedComplaints}\nHigh Priority: ${reportData.highPriorityComplaints}\nActive Agents: ${reportData.activeAgents}\n\nResolution Rate: ${Math.round((reportData.resolvedComplaints / reportData.totalComplaints) * 100)}%`;
                
                const blob = new Blob([reportText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ResolveIT_Report_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }
        }

        function refreshData() {
            loadAdminData();
        }

        function addComplaint() {
            if (confirm('Open new complaint form?')) {
                window.location.href = 'submit-complaint.html';
            }
        }
    </script>
</body>
</html>