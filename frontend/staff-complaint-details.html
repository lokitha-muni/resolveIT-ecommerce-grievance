<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Complaint Details â€“ ResolveIT</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="staff-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="complaint-details-body">
    <div class="complaint-split-bg">
        <div class="complaint-bg-left"></div>
        <div class="complaint-bg-right"></div>
    </div>

    <div class="complaint-main">
        <nav class="complaint-nav">
            <div class="nav-left">
                <div class="profile-photo" onclick="window.location.href='staff-profile.html'" id="profilePhoto" style="cursor: pointer;">S</div>
                <span id="userGreeting">Hi, Staff</span>
            </div>
            <div class="nav-right">
                <a href="staff-dashboard.html" class="nav-btn">Dashboard</a>
                <a href="staff-my-queue.html" class="nav-btn">My Queue</a>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </nav>

        <div class="page-title">
            <h1>Complaint Details</h1>
        </div>

        <div class="complaint-content">
            <div class="left-column">
                <div class="complaint-header-card">
                    <div class="detail-row">
                        <span class="label">Complaint ID:</span>
                        <span class="value" id="complaintId">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Customer Email:</span>
                        <span class="value" id="userEmail">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Order ID:</span>
                        <span class="value" id="orderId">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Issue Type:</span>
                        <span class="value" id="issueType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Current Status:</span>
                        <span class="value" id="currentStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Date Submitted:</span>
                        <span class="value" id="dateSubmitted">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Description:</span>
                        <span class="value" id="description">Loading...</span>
                    </div>
                </div>

                <div class="timeline-card">
                    <h3>Status History</h3>
                    <div class="timeline" id="timeline">
                        <!-- Timeline will be loaded dynamically -->
                    </div>
                </div>
            </div>

            <div class="right-column">
                <!-- Staff Notes -->
                <div class="user-view-card">
                    <h3>Staff Notes</h3>
                    <div class="notes-list" id="notesList">
                        <!-- Notes loaded dynamically -->
                    </div>
                    <div class="add-note">
                        <textarea id="newNote" placeholder="Add internal note..." rows="3"></textarea>
                        <label><input type="checkbox" id="isInternal" checked> Internal Note</label>
                        <button onclick="addStaffNote()" class="action-btn">Add Note</button>
                    </div>
                </div>
                
                <!-- Customer Communication -->
                <div class="user-view-card">
                    <h3>Customer Communication</h3>
                    <div class="messages-list" id="messagesList">
                        <!-- Messages loaded dynamically -->
                    </div>
                    <div class="send-message">
                        <textarea id="newMessage" placeholder="Send message to customer..." rows="3"></textarea>
                        <button onclick="sendMessage()" class="action-btn">Send Message</button>
                    </div>
                </div>
                
                <!-- Staff Actions -->
                <div class="user-view-card">
                    <h3>Staff Actions</h3>
                    
                    <div class="status-update-section">
                        <label for="statusSelect">Update Status:</label>
                        <select id="statusSelect">
                            <option value="PENDING">Pending</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="RESOLVED">Resolved</option>
                        </select>
                        <button onclick="updateStatus()" class="action-btn">Update Status</button>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn" onclick="window.location.href='staff-my-queue.html'">Back to My Queue</button>
                        <button class="action-btn secondary" onclick="window.print()">Print Details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentComplaintId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadComplaintDetails();
            loadUserData();
        });

        async function loadUserData() {
            const staff = JSON.parse(localStorage.getItem('staff'));
            if (!staff || !staff.email) {
                window.location.href = 'staff-login.html';
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:9090/api/staff/profile/${staff.email}`);
                if (response.ok) {
                    const data = await response.json();
                    const displayName = data.firstName || staff.email.split('@')[0];
                    document.getElementById('userGreeting').textContent = `Hi, ${displayName}`;
                    document.getElementById('profilePhoto').textContent = displayName.charAt(0).toUpperCase();
                } else {
                    const username = staff.email.split('@')[0];
                    document.getElementById('userGreeting').textContent = `Hi, ${username}`;
                    document.getElementById('profilePhoto').textContent = username.charAt(0).toUpperCase();
                }
            } catch (error) {
                const username = staff.email.split('@')[0];
                document.getElementById('userGreeting').textContent = `Hi, ${username}`;
                document.getElementById('profilePhoto').textContent = username.charAt(0).toUpperCase();
            }
        }

        async function loadComplaintDetails() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const complaintId = urlParams.get('id');
                currentComplaintId = complaintId;

                if (!complaintId) {
                    alert('No complaint ID provided');
                    window.location.href = 'staff-queue.html';
                    return;
                }

                const response = await fetch(`http://localhost:9090/api/staff/complaint/${complaintId}`);

                if (!response.ok) {
                    throw new Error('Complaint not found');
                }

                const complaint = await response.json();
                displayComplaintDetails(complaint);
                loadStaffNotes(complaintId);
                loadMessages(complaintId);

            } catch (error) {
                console.error('Error loading complaint details:', error);
                alert('Failed to load complaint details');
                window.location.href = 'staff-queue.html';
            }
        }

        function displayComplaintDetails(complaint) {
            document.getElementById('complaintId').textContent = complaint.complaintId;
            document.getElementById('userEmail').textContent = complaint.userEmail;
            document.getElementById('orderId').textContent = complaint.orderId;
            document.getElementById('issueType').textContent = complaint.issueType;
            document.getElementById('currentStatus').textContent = complaint.status;
            document.getElementById('description').textContent = complaint.description;

            const createdDate = new Date(complaint.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('dateSubmitted').textContent = createdDate;

            // Set current status in dropdown
            document.getElementById('statusSelect').value = complaint.status;

            updateTimeline(complaint);
        }

        function updateTimeline(complaint) {
            const timeline = document.getElementById('timeline');
            const createdDate = new Date(complaint.createdAt).toLocaleDateString();
            const updatedDate = new Date(complaint.updatedAt).toLocaleDateString();

            let timelineItems = [
                {
                    date: createdDate,
                    content: 'Complaint submitted by customer'
                }
            ];

            if (complaint.status === 'IN_PROGRESS') {
                timelineItems.unshift({
                    date: updatedDate,
                    content: 'Status updated to In Progress'
                });
            } else if (complaint.status === 'RESOLVED') {
                timelineItems.unshift({
                    date: updatedDate,
                    content: 'Complaint resolved by staff'
                });
            }

            let html = '';
            timelineItems.forEach(item => {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-date">${item.date}</div>
                        <div class="timeline-content">${item.content}</div>
                    </div>
                `;
            });

            timeline.innerHTML = html;
        }
        
        async function loadStaffNotes(complaintId) {
            try {
                const response = await fetch(`http://localhost:9090/api/staff/notes/${complaintId}`);
                const notes = await response.json();
                
                const notesList = document.getElementById('notesList');
                notesList.innerHTML = '';
                
                notes.forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'note-item';
                    noteDiv.innerHTML = `
                        <div class="note-author">${note.staffEmail} ${note.internal ? '(Internal)' : ''}</div>
                        <div class="note-content">${note.note}</div>
                        <div class="note-time">${new Date(note.createdAt).toLocaleString()}</div>
                    `;
                    notesList.appendChild(noteDiv);
                });
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        async function addStaffNote() {
            const noteText = document.getElementById('newNote').value.trim();
            const isInternal = document.getElementById('isInternal').checked;
            
            if (!noteText) return;
            
            const staff = JSON.parse(localStorage.getItem('staff'));
            
            try {
                const response = await fetch('http://localhost:9090/api/staff/note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        complaintId: currentComplaintId,
                        staffEmail: staff.email,
                        note: noteText,
                        internal: isInternal
                    })
                });
                
                if (response.ok) {
                    document.getElementById('newNote').value = '';
                    loadStaffNotes(currentComplaintId);
                } else {
                    alert('Failed to add note');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                alert('Failed to add note');
            }
        }
        
        async function loadMessages(complaintId) {
            try {
                const response = await fetch(`http://localhost:9090/api/comments/complaint/${complaintId}`);
                const messages = await response.json();
                
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = '';
                
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message-item';
                    messageDiv.innerHTML = `
                        <div class="message-author">${message.authorType}: ${message.authorEmail}</div>
                        <div class="message-content">${message.message}</div>
                        <div class="message-time">${new Date(message.createdAt).toLocaleString()}</div>
                    `;
                    messagesList.appendChild(messageDiv);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        async function sendMessage() {
            const messageText = document.getElementById('newMessage').value.trim();
            if (!messageText) return;
            
            const staff = JSON.parse(localStorage.getItem('staff'));
            
            try {
                const response = await fetch('http://localhost:9090/api/comments/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        complaintId: currentComplaintId,
                        authorEmail: staff.email,
                        authorType: 'STAFF',
                        message: messageText
                    })
                });
                
                if (response.ok) {
                    document.getElementById('newMessage').value = '';
                    loadMessages(currentComplaintId);
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        async function updateStatus() {
            const newStatus = document.getElementById('statusSelect').value;
            
            if (!currentComplaintId) {
                alert('No complaint selected');
                return;
            }

            try {
                const response = await fetch(`http://localhost:9090/api/staff/complaint/${currentComplaintId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('Status updated successfully!');
                    loadComplaintDetails(); // Reload to show updated data
                } else {
                    alert('Failed to update status: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status');
            }
        }

        async function logout() {
            try {
                const staff = JSON.parse(localStorage.getItem('staff'));
                if (staff && staff.email) {
                    await fetch('http://localhost:9090/api/staff/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: staff.email })
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                localStorage.removeItem('staff');
                window.location.href = 'staff-login.html';
            }
        }
    </script>
</body>
</html>
